<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOME DJ - ВК Мини-приложение</title>
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <style>
        /* Ваши стили остаются без изменений */
        :root {
            --accent-color: #FFFF00;
            --accent-dark: #CCCC00;
            --accent-shadow: rgba(255,255,0,0.5);
            --accent-hover: #FFD700;
            --cue-playing-color: #FF0000;
            --cue-shadow: rgba(255,0,0,0.5);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #000;
            color: #fff;
            padding: 10px;
            opacity: 0;
            animation: startupAnimation 2s forwards;
        }
        
        /* ... остальные стили без изменений ... */
        
        @media (max-width: 768px) {
            /* ... медиа-запросы без изменений ... */
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HTML-структура без изменений -->
        <header>
            <div class="logo-container">
                <div class="logo">HOME DJ</div>
                <a href="https://vk.com/HDJ_vk" target="_blank" id="vk-channel-link" class="vk-channel-link">
                    <div class="hdj-rectangle">HDJ</div>
                </a>
            </div>
            <div class="color-picker">
                <div class="color-option active" style="background-color: #FFFF00;" data-color="#FFFF00" data-dark="#CCCC00" data-shadow="rgba(255,255,0,0.5)" data-hover="#FFD700" data-cue-playing="#FF0000" data-cue-shadow="rgba(255,0,0,0.5)"></div>
                <div class="color-option" style="background-color: #FFFFFF;" data-color="#FFFFFF" data-dark="#CCCCCC" data-shadow="rgba(255,255,255,0.5)" data-hover="#E6E6E6" data-cue-playing="#FF0000" data-cue-shadow="rgba(255,0,0,0.5)"></div>
                <div class="color-option" style="background-color: #0000FF;" data-color="#0000FF" data-dark="#0000CC" data-shadow="rgba(0,0,255,0.5)" data-hover="#3333FF" data-cue-playing="#FF0000" data-cue-shadow="rgba(255,0,0,0.5)"></div>
                <div class="color-option" style="background-color: #FF0000;" data-color="#FF0000" data-dark="#CC0000" data-shadow="rgba(255,0,0,0.5)" data-hover="#FF3333" data-cue-playing="#FFFF00" data-cue-shadow="rgba(255,255,0,0.5)"></div>
            </div>
            <div class="user-info" id="userInfo" style="display: none;">
                <div class="user-avatar" id="userAvatar"></div>
                <div class="user-name" id="userName"></div>
                <button class="logout-btn" id="logoutBtn">Выйти</button>
            </div>
            <div class="user" id="loginButton">
                <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2ZmMCIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0Ij48cGF0aCBkPSJNMTIgMkM2LjQ4IDIgMiA2LjQ4IDIgMTJzNC40OCAxMCAxMCAxMCAxMC00LjQ4IDEwLTEwUzE3LjUyIDIgMTIgMnptMCAzYzEuNjYgMCAzIDEuMzQgMyAzcy0xLjM0IDMtMyAzLTMtMS4zNC0zLTMgMS4zNC0zIDMtM3ptMCAxNC4yYy0yLjUgMC00LjcxLTEuMjgtNi00LjIyLjAzLTIuOTkgNi0zLjAyIDYgNC4yMnptMC0xNy4xN2ExMCAxMCAwIDEwMCAyMCAxMCAxMCAwIDAwLTEwLTEweiIvPjwvc3ZnPg==" alt="User" width="30">
            </div>
        </header>
        
        <div class="main-content">
            <!-- ... остальная HTML-структура без изменений ... -->
        </div>
        
        <div class="playlist-modal" id="playlistModal">
            <!-- ... модальное окно плейлиста без изменений ... -->
        </div>
        
        <div class="auth-modal" id="authModal">
            <!-- ... модальное окно авторизации без изменений ... -->
        </div>
    </div>

    <div class="developer-signature-hidden">Разработчик Первушин Е.Ю</div>

    <script>
        // Инициализация VK Mini App
        vkBridge.send('VKWebAppInit', {})
            .then(data => {
                console.log('VK Mini App initialized');
                initApp();
            })
            .catch(error => {
                console.error('VK init error:', error);
                // Fallback для запуска вне VK
                initApp();
            });

        function initApp() {
            document.addEventListener('DOMContentLoaded', function() {
                // Константы и переменные
                const modal = document.getElementById('playlistModal');
                const closeBtn = document.getElementById('closeModal');
                const statusIndicator = document.getElementById('statusIndicator');
                const crossfader = document.getElementById('crossfader');
                const vinylA = document.getElementById('vinylA');
                const vinylB = document.getElementById('vinylB');
                const cuePlayA = document.getElementById('cuePlayA');
                const cuePlayB = document.getElementById('cuePlayB');
                const syncA = document.getElementById('syncA');
                const syncB = document.getElementById('syncB');
                const waveformA = document.getElementById('waveformA');
                const waveformB = document.getElementById('waveformB');
                const loadTrackA = document.getElementById('loadTrackA');
                const loadTrackB = document.getElementById('loadTrackB');
                const waveformContainerA = document.getElementById('waveformContainerA');
                const waveformContainerB = document.getElementById('waveformContainerB');
                const colorOptions = document.querySelectorAll('.color-option');
                const pitchIncreaseBtns = document.querySelectorAll('.pitch-increase');
                const pitchDecreaseBtns = document.querySelectorAll('.pitch-decrease');
                const loopButtons = document.querySelectorAll('.loop-btn');
                const vuLevelA = document.getElementById('vuLevelA');
                const vuLevelB = document.getElementById('vuLevelB');
                const vuPeakA = document.getElementById('vuPeakA');
                const vuPeakB = document.getElementById('vuPeakB');
                const vuScaleA = document.querySelector('#vuMeterA .vu-scale');
                const vuScaleB = document.querySelector('#vuMeterB .vu-scale');
                const trackCoverA = document.querySelector('#trackCoverA img');
                const trackCoverB = document.querySelector('#trackCoverB img');
                const vkChannelLink = document.getElementById('vk-channel-link');
                const hdjRectangle = document.querySelector('.hdj-rectangle');
                const keyLockA = document.getElementById('keyLockA');
                const keyLockB = document.getElementById('keyLockB');
                const authModal = document.getElementById('authModal');
                const authButton = document.getElementById('authButton');
                const loginButton = document.getElementById('loginButton');
                const userInfo = document.getElementById('userInfo');
                const userAvatar = document.getElementById('userAvatar');
                const userName = document.getElementById('userName');
                const logoutBtn = document.getElementById('logoutBtn');
                const playlistTracks = document.getElementById('playlistTracks');
                const playlistTabs = document.querySelectorAll('.playlist-tab');
                
                let activeDeck = 'A';
                let isPlaying = false;
                let timerInterval;
                let seconds = 0;
                let clickTimerA = null;
                let clickTimerB = null;
                let vuIntervalA = null;
                let vuIntervalB = null;
                let peakLevelA = 0;
                let peakLevelB = 0;
                let peakTimeoutA = null;
                let peakTimeoutB = null;
                let isAuthorized = false;
                let userData = null;
                
                // Новые переменные для Key Lock и Scratch Mode
                let keyLockState = { A: false, B: false };
                let scratchModeState = { A: false, B: false };
                let isScratching = { A: false, B: false };
                let originalPitch = { A: 0, B: 0 };
                
                const trackData = {
                    A: { 
                        duration: 225, 
                        currentTime: 0, 
                        playing: false, 
                        interval: null, 
                        baseBpm: 128, 
                        loop: { active: false, startPoint: 0, endPoint: 0, beats: 0 },
                        originalKey: '--',
                        currentKey: '--'
                    },
                    B: { 
                        duration: 260, 
                        currentTime: 0, 
                        playing: false, 
                        interval: null, 
                        baseBpm: 135, 
                        loop: { active: false, startPoint: 0, endPoint: 0, beats: 0 },
                        originalKey: '--',
                        currentKey: '--'
                    }
                };
                
                // Инициализация
                statusIndicator.classList.add('status-connected');
                createWaveformBars('A');
                createWaveformBars('B');
                updateTimeInfo('A');
                updateTimeInfo('B');
                createVUScale('A');
                createVUScale('B');
                
                // Функция авторизации через VK
                function initVKAuth() {
                    authButton.addEventListener('click', function() {
                        vkBridge.send('VKWebAppGetAuthToken', {
                            app_id: 5138643, // Ваш app_id из app.json
                            scope: 'audio'
                        })
                        .then(data => {
                            handleAuthSuccess(data);
                        })
                        .catch(error => {
                            console.error('Auth error:', error);
                            // Эмуляция авторизации для демонстрации
                            handleAuthSuccess({
                                access_token: 'demo_token',
                                user: {
                                    id: 123456,
                                    first_name: 'Демо',
                                    last_name: 'Пользователь'
                                }
                            });
                        });
                    });
                }
                
                // Обработка успешной авторизации
                function handleAuthSuccess(data) {
                    isAuthorized = true;
                    authModal.style.display = 'none';
                    
                    // Получаем информацию о пользователе
                    vkBridge.send('VKWebAppGetUserInfo', {})
                        .then(userResponse => {
                            userData = userResponse;
                            updateUserInfo();
                        })
                        .catch(error => {
                            console.error('Get user info error:', error);
                            // Демо-данные
                            userData = {
                                first_name: 'Демо',
                                last_name: 'Пользователь',
                                photo_100: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBmaWxsPSIjZmZmIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI1MCIgZmlsbD0iIzMzMyIvPjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBmaWxsPSIjZmZmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIj5Vc2VyPC90ZXh0Pjwvc3ZnPg=='
                            };
                            updateUserInfo();
                        });
                    
                    // Активируем кнопки загрузки треков
                    loadTrackA.classList.remove('disabled');
                    loadTrackB.classList.remove('disabled');
                    
                    // Загружаем плейлисты пользователя
                    loadUserPlaylists();
                }
                
                // Обновление информации о пользователе
                function updateUserInfo() {
                    if (userData) {
                        userInfo.style.display = 'flex';
                        loginButton.style.display = 'none';
                        
                        userName.textContent = `${userData.first_name} ${userData.last_name}`;
                        
                        const avatarImg = document.createElement('img');
                        avatarImg.src = userData.photo_100;
                        avatarImg.alt = 'User Avatar';
                        userAvatar.innerHTML = '';
                        userAvatar.appendChild(avatarImg);
                    }
                }
                
                // Загрузка плейлистов пользователя
                function loadUserPlaylists() {
                    // Для VK Mini Apps используем VK Bridge для вызова API
                    vkBridge.send('VKWebAppCallAPIMethod', {
                        method: 'audio.getPlaylists',
                        params: {
                            owner_id: userData.id || userData.user_id,
                            count: 20,
                            v: '5.131'
                        }
                    })
                    .then(response => {
                        if (response.response) {
                            displayPlaylists(response.response.items);
                        }
                    })
                    .catch(error => {
                        console.error('Get playlists error:', error);
                        // Демо-плейлисты
                        const demoPlaylists = [
                            {
                                id: 1,
                                title: 'Мой любимый плейлист',
                                photo: { photo_300: 'https://source.unsplash.com/featured/?music,playlist' },
                                count: 15
                            },
                            {
                                id: 2,
                                title: 'Для работы',
                                photo: { photo_300: 'https://source.unsplash.com/featured/?work,music' },
                                count: 12
                            },
                            {
                                id: 3,
                                title: 'Танцевальные хиты',
                                photo: { photo_300: 'https://source.unsplash.com/featured/?dance,music' },
                                count: 25
                            }
                        ];
                        
                        displayPlaylists(demoPlaylists);
                    });
                }
                
                // Отображение плейлистов
                function displayPlaylists(playlists) {
                    playlistTracks.innerHTML = '';
                    
                    if (playlists.length === 0) {
                        playlistTracks.innerHTML = '<li class="playlist-empty">У вас нет плейлистов</li>';
                        return;
                    }
                    
                    playlists.forEach(playlist => {
                        const li = document.createElement('li');
                        li.className = 'playlist-track';
                        li.dataset.id = playlist.id;
                        li.dataset.type = 'playlist';
                        
                        li.innerHTML = `
                            <div class="track-cover-modal">
                                <img src="${playlist.photo.photo_300 || 'https://source.unsplash.com/featured/?music'}" alt="${playlist.title}">
                            </div>
                            <div class="track-info-modal">
                                <div class="track-name-modal">${playlist.title}</div>
                                <div class="track-artist-modal">${playlist.count} треков</div>
                            </div>
                        `;
                        
                        li.addEventListener('click', () => {
                            loadPlaylistTracks(playlist.id);
                        });
                        
                        playlistTracks.appendChild(li);
                    });
                }
                
                // Загрузка треков из плейлиста
                function loadPlaylistTracks(playlistId) {
                    vkBridge.send('VKWebAppCallAPIMethod', {
                        method: 'audio.get',
                        params: {
                            playlist_id: playlistId,
                            v: '5.131'
                        }
                    })
                    .then(response => {
                        if (response.response) {
                            displayTracks(response.response.items);
                        }
                    })
                    .catch(error => {
                        console.error('Get playlist tracks error:', error);
                        // Демо-треки
                        const demoTracks = [
                            {
                                id: 1,
                                title: 'Deep House Vibes',
                                artist: 'Deep House Collective',
                                duration: 225,
                                url: 'https://example.com/track1.mp3'
                            },
                            {
                                id: 2,
                                title: 'Techno Revolution',
                                artist: 'Techno Masters',
                                duration: 260,
                                url: 'https://example.com/track2.mp3'
                            },
                            {
                                id: 3,
                                title: 'Sunset Lounge',
                                artist: 'Chillout Band',
                                duration: 315,
                                url: 'https://example.com/track3.mp3'
                            }
                        ];
                        
                        displayTracks(demoTracks);
                    });
                }
                
                // Отображение треков
                function displayTracks(tracks) {
                    playlistTracks.innerHTML = '';
                    
                    if (tracks.length === 0) {
                        playlistTracks.innerHTML = '<li class="playlist-empty">В плейлисте нет треков</li>';
                        return;
                    }
                    
                    tracks.forEach(track => {
                        const li = document.createElement('li');
                        li.className = 'playlist-track';
                        li.dataset.id = track.id;
                        li.dataset.title = track.title;
                        li.dataset.artist = track.artist;
                        li.dataset.duration = track.duration;
                        li.dataset.url = track.url;
                        
                        // Генерация BPM для демо (в реальном приложении это будет приходить из API)
                        const bpm = Math.floor(Math.random() * 40) + 100;
                        
                        li.innerHTML = `
                            <div class="track-cover-modal">
                                <img src="https://source.unsplash.com/featured/?music,album" alt="${track.title}">
                            </div>
                            <div class="track-info-modal">
                                <div class="track-name-modal">${track.title}</div>
                                <div class="track-artist-modal">${track.artist} · ${formatTime(track.duration)}</div>
                            </div>
                            <div class="track-bpm">${bpm}</div>
                        `;
                        
                        li.addEventListener('click', function() {
                            const trackName = this.dataset.title;
                            const artistName = this.dataset.artist;
                            const duration = this.dataset.duration;
                            const bpm = parseInt(this.querySelector('.track-bpm').textContent);
                            const coverUrl = this.querySelector('img').src;
                            
                            const durationParts = formatTime(duration);
                            
                            document.getElementById(`trackName${activeDeck}`).textContent = trackName;
                            document.getElementById(`trackArtist${activeDeck}`).textContent = artistName;
                            document.getElementById(`bpmLarge${activeDeck}`).textContent = bpm.toFixed(1);
                            document.getElementById(`totalTime${activeDeck}`).textContent = `/ ${durationParts}`;
                            
                            trackData[activeDeck].duration = parseInt(duration);
                            trackData[activeDeck].currentTime = 0;
                            trackData[activeDeck].baseBpm = bpm;
                            
                            resetPitch(activeDeck);
                            
                            trackData[activeDeck].loop.active = false;
                            document.querySelectorAll(`.loop-btn[data-deck="${activeDeck}"]`).forEach(btn => {
                                btn.classList.remove('active');
                            });
                            
                            updateTimeInfo(activeDeck);
                            analyzeTrack(activeDeck, trackName, artistName, bpm, durationParts, coverUrl);
                            
                            const bpmA = parseFloat(document.getElementById('bpmLargeA').textContent);
                            const bpmB = parseFloat(document.getElementById('bpmLargeB').textContent);
                            document.querySelector('.master-bpm-display').textContent = `Master: ${((bpmA + bpmB) / 2).toFixed(1)} BPM`;
                            
                            modal.style.display = 'none';
                        });
                        
                        playlistTracks.appendChild(li);
                    });
                }
                
                // Выход из аккаунта
                logoutBtn.addEventListener('click', function() {
                    vkBridge.send('VKWebAppLogout', {})
                        .then(() => {
                            handleLogout();
                        })
                        .catch(error => {
                            console.error('Logout error:', error);
                            handleLogout();
                        });
                });
                
                // Обработка выхода
                function handleLogout() {
                    isAuthorized = false;
                    userData = null;
                    userInfo.style.display = 'none';
                    loginButton.style.display = 'block';
                    
                    loadTrackA.classList.add('disabled');
                    loadTrackB.classList.add('disabled');
                    
                    playlistTracks.innerHTML = '<li class="playlist-empty">Войдите в VK, чтобы загрузить ваши плейлисты</li>';
                }
                
                // Переключение между плейлистами и аудиозаписями
                playlistTabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        playlistTabs.forEach(t => t.classList.remove('active'));
                        this.classList.add('active');
                        
                        if (this.dataset.type === 'playlists') {
                            loadUserPlaylists();
                        } else {
                            // Загрузка аудиозаписей пользователя
                            vkBridge.send('VKWebAppCallAPIMethod', {
                                method: 'audio.get',
                                params: {
                                    count: 50,
                                    v: '5.131'
                                }
                            })
                            .then(response => {
                                if (response.response) {
                                    displayTracks(response.response.items);
                                }
                            })
                            .catch(error => {
                                console.error('Get audio error:', error);
                                // Демо-аудиозаписи
                                const demoTracks = [
                                    {
                                        id: 101,
                                        title: 'My Favorite Song',
                                        artist: 'Favorite Artist',
                                        duration: 180,
                                        url: 'https://example.com/favorite.mp3'
                                    },
                                    {
                                        id: 102,
                                        title: 'Chill Vibes',
                                        artist: 'Chill Artist',
                                        duration: 240,
                                        url: 'https://example.com/chill.mp3'
                                    },
                                    {
                                        id: 103,
                                        title: 'Energy Boost',
                                        artist: 'Energy Artist',
                                        duration: 200,
                                        url: 'https://example.com/energy.mp3'
                                    }
                                ];
                                
                                displayTracks(demoTracks);
                            });
                        }
                    });
                });
                
                // Инициализация авторизации
                initVKAuth();
                
                // Запуск мигания кнопки ВК каждые 3 минуты
                setInterval(function() {
                    hdjRectangle.classList.add('blink-red');
                    setTimeout(function() {
                        hdjRectangle.classList.remove('blink-red');
                    }, 3000);
                }, 180000);
                
                // Создание шкалы VU-метра
                function createVUScale(deckId) {
                    const scale = deckId === 'A' ? vuScaleA : vuScaleB;
                    scale.innerHTML = '';
                    
                    for (let i = 0; i <= 10; i++) {
                        const line = document.createElement('div');
                        line.className = 'vu-scale-line';
                        if (i % 2 === 0) line.classList.add('major');
                        scale.appendChild(line);
                    }
                }
                
                // Обновление VU-метра
                function updateVUMeter(deckId, level) {
                    const vuLevel = deckId === 'A' ? vuLevelA : vuLevelB;
                    const vuPeak = deckId === 'A' ? vuPeakA : vuPeakB;
                    
                    vuLevel.style.height = `${level}%`;
                    
                    if (level > (deckId === 'A' ? peakLevelA : peakLevelB)) {
                        if (deckId === 'A') {
                            peakLevelA = level;
                            clearTimeout(peakTimeoutA);
                            peakTimeoutA = setTimeout(() => { peakLevelA = 0; }, 2000);
                        } else {
                            peakLevelB = level;
                            clearTimeout(peakTimeoutB);
                            peakTimeoutB = setTimeout(() => { peakLevelB = 0; }, 2000);
                        }
                    }
                    
                    const peakLevel = deckId === 'A' ? peakLevelA : peakLevelB;
                    vuPeak.style.top = `${100 - peakLevel}%`;
                }
                
                // Запуск анимации VU-метра
                function startVUMeter(deckId) {
                    if (deckId === 'A' && vuIntervalA) clearInterval(vuIntervalA);
                    if (deckId === 'B' && vuIntervalB) clearInterval(vuIntervalB);
                    
                    const interval = setInterval(() => {
                        const level = Math.min(100, Math.floor(Math.random() * 110));
                        updateVUMeter(deckId, level);
                    }, 100);
                    
                    if (deckId === 'A') vuIntervalA = interval;
                    else vuIntervalB = interval;
                }
                
                // Остановка анимации VU-метра
                function stopVUMeter(deckId) {
                    if (deckId === 'A') {
                        clearInterval(vuIntervalA);
                        vuIntervalA = null;
                        updateVUMeter('A', 0);
                    } else {
                        clearInterval(vuIntervalB);
                        vuIntervalB = null;
                        updateVUMeter('B', 0);
                    }
                }
                
                // Функция для Key Lock - сохранение тональности при изменении темпа
                function toggleKeyLock(deckId) {
                    keyLockState[deckId] = !keyLockState[deckId];
                    const keyLockBtn = document.getElementById(`keyLock${deckId}`);
                    
                    if (keyLockState[deckId]) {
                        keyLockBtn.classList.add('active');
                        // Сохраняем оригинальную тональность при включении Key Lock
                        trackData[deckId].originalKey = trackData[deckId].currentKey;
                    } else {
                        keyLockBtn.classList.remove('active');
                        // При выключении Key Lock обновляем тональность в соответствии с текущим pitch
                        updateKeyBasedOnPitch(deckId);
                    }
                    
                    updateKeyDisplay(deckId);
                }
                
                // Функция для обновления тональности на основе значения pitch
                function updateKeyBasedOnPitch(deckId) {
                    if (trackData[deckId].originalKey === '--') return;
                    
                    const pitchValue = parseFloat(document.getElementById(`pitch${deckId}`).value);
                    const semitonesChange = Math.round(pitchValue / 6); // 6% pitch ≈ 1 полутон
                    
                    if (semitonesChange === 0) {
                        trackData[deckId].currentKey = trackData[deckId].originalKey;
                    } else {
                        const keyMap = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                        const originalKey = trackData[deckId].originalKey;
                        const isMinor = originalKey.includes('m');
                        const baseKey = isMinor ? originalKey.replace('m', '') : originalKey;
                        
                        let keyIndex = keyMap.indexOf(baseKey);
                        if (keyIndex === -1) return;
                        
                        let newKeyIndex = (keyIndex + semitonesChange + 12) % 12;
                        trackData[deckId].currentKey = keyMap[newKeyIndex] + (isMinor ? 'm' : '');
                    }
                    
                    updateKeyDisplay(deckId);
                }
                
                // Функция для обновления отображения тональности
                function updateKeyDisplay(deckId) {
                    const keyElement = document.getElementById(`trackKey${deckId}`);
                    
                    if (keyLockState[deckId] && !scratchModeState[deckId]) {
                        // Key Lock включен и не в режиме скретча - показываем оригинальную тональность
                        keyElement.textContent = `Key: ${trackData[deckId].originalKey} (LOCKED)`;
                        keyElement.style.color = '#4cc9f0';
                    } else if (scratchModeState[deckId]) {
                        // Режим скретча - показываем, что Key Lock временно отключен
                        keyElement.textContent = `Key: ${trackData[deckId].currentKey} (SCRATCH)`;
                        keyElement.style.color = '#ff0000';
                    } else {
                        // Key Lock выключен - показываем текущую тональность
                        keyElement.textContent = `Key: ${trackData[deckId].currentKey}`;
                        keyElement.style.color = '#4cc9f0';
                    }
                }
                
                // Функция для активации/деактивации режима скретча
                function toggleScratchMode(deckId, enable) {
                    if (enable) {
                        // Активация режима скретча
                        scratchModeState[deckId] = true;
                        originalPitch[deckId] = parseFloat(document.getElementById(`pitch${deckId}`).value);
                        
                        // Сбрасываем pitch к 0 для чистого скретча
                        document.getElementById(`pitch${deckId}`).value = 0;
                        document.getElementById(`pitch${deckId}`).dispatchEvent(new Event('input'));
                        
                        // Визуальные изменения для индикации режима скретча
                        document.getElementById(`vinyl${deckId}`).classList.add('scratching');
                    } else {
                        // Деактивация режима скретча
                        scratchModeState[deckId] = false;
                        
                        // Восстанавливаем оригинальный pitch
                        document.getElementById(`pitch${deckId}`).value = originalPitch[deckId];
                        document.getElementById(`pitch${deckId}`).dispatchEvent(new Event('input'));
                        
                        // Убираем визуальные индикаторы скретча
                        document.getElementById(`vinyl${deckId}`).classList.remove('scratching');
                    }
                    
                    updateKeyDisplay(deckId);
                }
                
                // Основные функции
                function changeColorScheme(color, dark, shadow, hover, cuePlaying, cueShadow) {
                    document.documentElement.style.setProperty('--accent-color', color);
                    document.documentElement.style.setProperty('--accent-dark', dark);
                    document.documentElement.style.setProperty('--accent-shadow', shadow);
                    document.documentElement.style.setProperty('--accent-hover', hover);
                    document.documentElement.style.setProperty('--cue-playing-color', cuePlaying);
                    document.documentElement.style.setProperty('--cue-shadow', cueShadow);
                }
                
                function changePitch(deckId, direction) {
                    const slider = document.getElementById(`pitch${deckId}`);
                    let value = parseFloat(slider.value);
                    
                    if (direction === 'increase') value = Math.min(8, value + 0.1);
                    else if (direction === 'decrease') value = Math.max(-8, value - 0.1);
                    
                    value = Math.round(value * 10) / 10;
                    slider.value = value;
                    slider.dispatchEvent(new Event('input'));
                }
                
                function toggleLoop(deckId, beats) {
                    const data = trackData[deckId];
                    const loopButtons = document.querySelectorAll(`.loop-btn[data-deck="${deckId}"]`);
                    
                    if (data.loop.active && data.loop.beats === beats) {
                        data.loop.active = false;
                        loopButtons.forEach(btn => btn.classList.remove('active'));
                        return;
                    }
                    
                    data.loop.active = true;
                    data.loop.startPoint = data.currentTime;
                    data.loop.beats = beats;
                    
                    const bpm = parseFloat(document.getElementById(`bpmLarge${deckId}`).textContent);
                    const beatDuration = 60 / bpm;
                    data.loop.endPoint = data.loop.startPoint + (beats * beatDuration);
                    
                    loopButtons.forEach(btn => {
                        btn.classList.toggle('active', parseInt(btn.getAttribute('data-beats')) === beats);
                    });
                }
                
                function createWaveformBars(deckId, intensity = 50) {
                    const container = document.getElementById(`waveformBars${deckId}`);
                    container.innerHTML = '';
                    
                    for (let i = 0; i < intensity; i++) {
                        const bar = document.createElement('div');
                        bar.className = 'waveform-bar';
                        bar.style.height = `${Math.random() * 70 + 30}%`;
                        container.appendChild(bar);
                    }
                }
                
                function formatTime(seconds) {
                    const mins = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
                }
                
                function updateTimeInfo(deckId) {
                    const data = trackData[deckId];
                    const currentTimeElement = document.getElementById(`currentTime${deckId}`);
                    const remainingTimeElement = document.getElementById(`remainingTime${deckId}`);
                    const progressElement = document.getElementById(`waveformProgress${deckId}`);
                    const waveformContainer = document.getElementById(`waveformContainer${deckId}`);
                    
                    currentTimeElement.textContent = formatTime(data.currentTime);
                    remainingTimeElement.textContent = `-${formatTime(data.duration - data.currentTime)}`;
                    
                    const progressPercent = (data.currentTime / data.duration) * 100;
                    progressElement.style.width = `${progressPercent}%`;
                    
                    if (data.duration - data.currentTime <= 15 && data.duration - data.currentTime > 0) {
                        waveformContainer.classList.add('warning');
                    } else {
                        waveformContainer.classList.remove('warning');
                    }
                }
                
                function startPlayback(deckId) {
                    if (trackData[deckId].interval) clearInterval(trackData[deckId].interval);
                    
                    trackData[deckId].playing = true;
                    trackData[deckId].interval = setInterval(() => {
                        if (trackData[deckId].currentTime < trackData[deckId].duration) {
                            trackData[deckId].currentTime++;
                            
                            if (trackData[deckId].loop.active && trackData[deckId].currentTime >= trackData[deckId].loop.endPoint) {
                                trackData[deckId].currentTime = trackData[deckId].loop.startPoint;
                            }
                            
                            updateTimeInfo(deckId);
                            
                            const bars = document.querySelectorAll(`#waveformBars${deckId} .waveform-bar`);
                            if (bars.length > 0) {
                                const randomBar = bars[Math.floor(Math.random() * bars.length)];
                                randomBar.style.height = `${Math.random() * 70 + 30}%`;
                            }
                        } else {
                            stopPlayback(deckId);
                        }
                    }, 1000);
                    
                    // Запускаем VU-метр
                    startVUMeter(deckId);
                }
                
                function stopPlayback(deckId) {
                    if (trackData[deckId].interval) {
                        clearInterval(trackData[deckId].interval);
                        trackData[deckId].interval = null;
                    }
                    trackData[deckId].playing = false;
                    
                    const waveformContainer = document.getElementById(`waveformContainer${deckId}`);
                    waveformContainer.classList.remove('warning');
                    
                    // Останавливаем VU-метр
                    stopVUMeter(deckId);
                }
                
                function resetTrack(deckId) {
                    stopPlayback(deckId);
                    trackData[deckId].currentTime = 0;
                    trackData[deckId].loop.active = false;
                    
                    document.querySelectorAll(`.loop-btn[data-deck="${deckId}"]`).forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    updateTimeInfo(deckId);
                    
                    const button = document.getElementById(`cuePlay${deckId}`);
                    button.innerHTML = '▶<br>CUE';
                    button.classList.remove('playing');
                    
                    const vinyl = document.getElementById(`vinyl${deckId}`);
                    vinyl.classList.remove('vinyl-rotating');
                    
                    document.getElementById(`waveformProgress${deckId}`).style.width = '0%';
                    
                    const waveformContainer = document.getElementById(`waveformContainer${deckId}`);
                    waveformContainer.classList.remove('warning');
                    
                    // Останавливаем VU-метр
                    stopVUMeter(deckId);
                    
                    // Сбрасываем Key Lock и Scratch Mode
                    keyLockState[deckId] = false;
                    scratchModeState[deckId] = false;
                    document.getElementById(`keyLock${deckId}`).classList.remove('active');
                    document.getElementById(`vinyl${deckId}`).classList.remove('scratching');
                    
                    // Сбрасываем тональность
                    trackData[deckId].originalKey = '--';
                    trackData[deckId].currentKey = '--';
                    document.getElementById(`trackKey${deckId}`).textContent = 'Key: --';
                    document.getElementById(`trackKey${deckId}`).style.color = '#4cc9f0';
                }
                
                function resetPitch(deckId) {
                    const slider = document.getElementById(`pitch${deckId}`);
                    slider.value = 0;
                    slider.dispatchEvent(new Event('input'));
                    
                    const pitchValue = document.getElementById(`pitchValue${deckId}`);
                    pitchValue.style.color = '#0f0';
                    setTimeout(() => pitchValue.style.color = 'var(--accent-color)', 300);
                }
                
                function syncBpm(targetDeckId) {
                    const sourceDeckId = targetDeckId === 'A' ? 'B' : 'A';
                    const sourceBpm = parseFloat(document.getElementById(`bpmLarge${sourceDeckId}`).textContent);
                    const targetBaseBpm = trackData[targetDeckId].baseBpm;
                    const requiredPitch = ((sourceBpm - targetBaseBpm) / targetBaseBpm) * 100;
                    
                    const pitchSlider = document.getElementById(`pitch${targetDeckId}`);
                    pitchSlider.value = Math.max(-8, Math.min(8, requiredPitch));
                    pitchSlider.dispatchEvent(new Event('input'));
                    
                    document.getElementById(`sync${targetDeckId}`).classList.add('active');
                    setTimeout(() => document.getElementById(`sync${targetDeckId}`).classList.remove('active'), 1000);
                }
                
                function analyzeTrack(deckId, trackName, artist, bpm, duration, coverUrl) {
                    const analysisStatus = document.getElementById(`analysisStatus${deckId}`);
                    const trackKey = document.getElementById(`trackKey${deckId}`);
                    
                    analysisStatus.textContent = 'Статус: Анализ выполняется...';
                    analysisStatus.style.color = '#4cc9f0';
                    
                    const keys = ['Cm', 'Gm', 'Dm', 'Am', 'Em', 'Bm', 'F#m', 'C#m', 'G#m', 'D#m', 'A#m', 'Fm'];
                    
                    setTimeout(() => {
                        const randomKey = keys[Math.floor(Math.random() * keys.length)];
                        trackData[deckId].originalKey = randomKey;
                        trackData[deckId].currentKey = randomKey;
                        trackKey.textContent = `Key: ${randomKey}`;
                        analysisStatus.textContent = 'Статус: Анализ завершен';
                        analysisStatus.style.color = '#0f0';
                        createWaveformBars(deckId, 100);
                        
                        // Устанавливаем обложку трека
                        const trackCover = deckId === 'A' ? trackCoverA : trackCoverB;
                        trackCover.src = coverUrl;
                        trackCover.alt = `Обложка: ${trackName}`;
                    }, 2000);
                }
                
                function checkLoadProtection(deckId) {
                    const crossfaderValue = parseInt(crossfader.value);
                    
                    // Для деки A: защита срабатывает если трек играет и кроссфейдер в левой позиции (< 30)
                    if (deckId === 'A' && trackData['A'].playing && crossfaderValue < 30) {
                        return true;
                    }
                    
                    // Для деки B: защита срабатывает если трек играет и кроссфейдер в правой позиции (> 70)
                    if (deckId === 'B' && trackData['B'].playing && crossfaderValue > 70) {
                        return true;
                    }
                    
                    return false;
                }
                
                // Функция мигания кнопки
                function blinkButton(button) {
                    button.classList.add('blink-warning');
                    setTimeout(() => {
                        button.classList.remove('blink-warning');
                    }, 1500);
                }
                
                function togglePlayPause(deckId, button) {
                    const vinyl = document.getElementById(`vinyl${deckId}`);
                    
                    if (!trackData[deckId].playing) {
                        button.innerHTML = '❚❚<br>PAUSE';
                        button.classList.add('playing');
                        vinyl.classList.add('vinyl-rotating');
                        startPlayback(deckId);
                        
                        if (!isPlaying) {
                            startTimer();
                            isPlaying = true;
                        }
                    } else {
                        button.innerHTML = '▶<br>CUE';
                        button.classList.remove('playing');
                        vinyl.classList.remove('vinyl-rotating');
                        stopPlayback(deckId);
                    }
                }
                
                function startTimer() {
                    clearInterval(timerInterval);
                    seconds = 0;
                    updateTimer();
                    
                    timerInterval = setInterval(() => {
                        seconds++;
                        updateTimer();
                    }, 1000);
                }
                
                function updateTimer() {
                    const hours = Math.floor(seconds / 3600);
                    const minutes = Math.floor((seconds % 3600) / 60);
                    const secs = seconds % 60;
                    
                    document.querySelector('.time-display').textContent = 
                        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                }
                
                // Обработчики событий
                colorOptions.forEach(option => {
                    option.addEventListener('click', function() {
                        colorOptions.forEach(opt => opt.classList.remove('active'));
                        this.classList.add('active');
                        
                        changeColorScheme(
                            this.getAttribute('data-color'),
                            this.getAttribute('data-dark'),
                            this.getAttribute('data-shadow'),
                            this.getAttribute('data-hover'),
                            this.getAttribute('data-cue-playing'),
                            this.getAttribute('data-cue-shadow')
                        );
                    });
                });
                
                pitchIncreaseBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        changePitch(this.getAttribute('data-deck'), 'increase');
                    });
                });
                
                pitchDecreaseBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        changePitch(this.getAttribute('data-deck'), 'decrease');
                    });
                });
                
                loopButtons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        toggleLoop(this.getAttribute('data-deck'), parseInt(this.getAttribute('data-beats')));
                    });
                });
                
                // Обработчики для Key Lock
                keyLockA.addEventListener('click', () => toggleKeyLock('A'));
                keyLockB.addEventListener('click', () => toggleKeyLock('B'));
                
                // Обработчики для Scratch Mode (джоги)
                vinylA.addEventListener('mousedown', () => {
                    isScratching.A = true;
                    toggleScratchMode('A', true);
                });
                
                vinylA.addEventListener('mouseup', () => {
                    isScratching.A = false;
                    toggleScratchMode('A', false);
                });
                
                vinylB.addEventListener('mousedown', () => {
                    isScratching.B = true;
                    toggleScratchMode('B', true);
                });
                
                vinylB.addEventListener('mouseup', () => {
                    isScratching.B = false;
                    toggleScratchMode('B', false);
                });
                
                // Обработка движения джоги для скретча
                vinylA.addEventListener('mousemove', (e) => {
                    if (isScratching.A) {
                        // Симуляция эффекта скретча - изменение скорости проигрывания
                        const rect = vinylA.getBoundingClientRect();
                        const centerX = rect.left + rect.width / 2;
                        const sensitivity = 0.5;
                        
                        if (trackData['A'].playing) {
                            const direction = e.clientX > centerX ? 1 : -1;
                            const speed = Math.abs(e.clientX - centerX) / (rect.width / 2) * sensitivity;
                            
                            // Ускорение или замедление воспроизведения в зависимости от движения
                            if (trackData['A'].interval) {
                                clearInterval(trackData['A'].interval);
                            }
                            
                            trackData['A'].interval = setInterval(() => {
                                trackData['A'].currentTime += direction * speed;
                                if (trackData['A'].currentTime < 0) trackData['A'].currentTime = 0;
                                if (trackData['A'].currentTime > trackData['A'].duration) trackData['A'].currentTime = trackData['A'].duration;
                                
                                updateTimeInfo('A');
                            }, 100);
                        }
                    }
                });
                
                vinylB.addEventListener('mousemove', (e) => {
                    if (isScratching.B) {
                        // Симуляция эффекта скретча - изменение скорости проигрывания
                        const rect = vinylB.getBoundingClientRect();
                        const centerX = rect.left + rect.width / 2;
                        const sensitivity = 0.5;
                        
                        if (trackData['B'].playing) {
                            const direction = e.clientX > centerX ? 1 : -1;
                            const speed = Math.abs(e.clientX - centerX) / (rect.width / 2) * sensitivity;
                            
                            // Ускорение или замедление воспроизведения в зависимости от движения
                            if (trackData['B'].interval) {
                                clearInterval(trackData['B'].interval);
                            }
                            
                            trackData['B'].interval = setInterval(() => {
                                trackData['B'].currentTime += direction * speed;
                                if (trackData['B'].currentTime < 0) trackData['B'].currentTime = 0;
                                if (trackData['B'].currentTime > trackData['B'].duration) trackData['B'].currentTime = trackData['B'].duration;
                                
                                updateTimeInfo('B');
                            }, 100);
                        }
                    }
                });
                
                loadTrackA.addEventListener('click', function() {
                    if (!isAuthorized) {
                        authModal.style.display = 'block';
                        return;
                    }
                    
                    if (checkLoadProtection('A')) {
                        blinkButton(this);
                        return;
                    }
                    
                    activeDeck = 'A';
                    modal.style.display = 'block';
                });
                
                loadTrackB.addEventListener('click', function() {
                    if (!isAuthorized) {
                        authModal.style.display = 'block';
                        return;
                    }
                    
                    if (checkLoadProtection('B')) {
                        blinkButton(this);
                        return;
                    }
                    
                    activeDeck = 'B';
                    modal.style.display = 'block';
                });
                
                closeBtn.addEventListener('click', () => modal.style.display = 'none');
                
                window.addEventListener('click', (event) => {
                    if (event.target === modal) modal.style.display = 'none';
                    if (event.target === authModal) authModal.style.display = 'none';
                });
                
                syncA.addEventListener('click', () => syncBpm('A'));
                syncB.addEventListener('click', () => syncBpm('B'));
                
                waveformA.addEventListener('click', function(e) {
                    const rect = this.getBoundingClientRect();
                    trackData['A'].currentTime = Math.floor((e.clientX - rect.left) / rect.width * trackData['A'].duration);
                    updateTimeInfo('A');
                });
                
                waveformB.addEventListener('click', function(e) {
                    const rect = this.getBoundingClientRect();
                    trackData['B'].currentTime = Math.floor((e.clientX - rect.left) / rect.width * trackData['B'].duration);
                    updateTimeInfo('B');
                });
                
                cuePlayA.addEventListener('click', function() {
                    if (clickTimerA) {
                        clearTimeout(clickTimerA);
                        clickTimerA = null;
                        resetTrack('A');
                        return;
                    }
                    
                    clickTimerA = setTimeout(() => {
                        togglePlayPause('A', cuePlayA);
                        clickTimerA = null;
                    }, 300);
                });
                
                cuePlayB.addEventListener('click', function() {
                    if (clickTimerB) {
                        clearTimeout(clickTimerB);
                        clickTimerB = null;
                        resetTrack('B');
                        return;
                    }
                    
                    clickTimerB = setTimeout(() => {
                        togglePlayPause('B', cuePlayB);
                        clickTimerB = null;
                    }, 300);
                });
                
                document.getElementById('pitchA').addEventListener('dblclick', () => resetPitch('A'));
                document.getElementById('pitchB').addEventListener('dblclick', () => resetPitch('B'));
                
                const pitchSliders = document.querySelectorAll('.slider-vertical');
                pitchSliders.forEach(slider => {
                    slider.addEventListener('input', function() {
                        const deckId = this.id.slice(-1);
                        const bpmDisplay = document.getElementById(`bpmLarge${deckId}`);
                        const pitchDisplay = document.getElementById(`pitchValue${deckId}`);
                        const vinyl = document.getElementById(`vinyl${deckId}`);
                        
                        const baseBpm = trackData[deckId].baseBpm;
                        const pitchValue = parseFloat(this.value);
                        const newBpm = baseBpm + (baseBpm * pitchValue / 100);
                        
                        bpmDisplay.textContent = newBpm.toFixed(1);
                        pitchDisplay.textContent = (pitchValue > 0 ? '+' : '') + pitchValue.toFixed(1) + '%';
                        
                        const rotationSpeed = 2 / (1 + Math.abs(pitchValue) / 10);
                        vinyl.style.animationDuration = `${rotationSpeed}s`;
                        
                        const bpmA = parseFloat(document.getElementById('bpmLargeA').textContent);
                        const bpmB = parseFloat(document.getElementById('bpmLargeB').textContent);
                        document.querySelector('.master-bpm-display').textContent = `Master: ${((bpmA + bpmB) / 2).toFixed(1)} BPM`;
                        
                        // Обновляем тональность если Key Lock выключен
                        if (!keyLockState[deckId] && !scratchModeState[deckId]) {
                            updateKeyBasedOnPitch(deckId);
                        }
                    });
                });
                
                crossfader.addEventListener('input', function() {
                    const value = this.value;
                    const deckA = document.getElementById('deckA');
                    const deckB = document.getElementById('deckB');
                    
                    if (value < 50) {
                        deckA.style.opacity = 1;
                        deckB.style.opacity = 0.5 + (value / 100);
                    } else {
                        deckA.style.opacity = 1.5 - (value / 100);
                        deckB.style.opacity = 1;
                    }
                });
                
                window.addEventListener('resize', () => {
                    createWaveformBars('A');
                    createWaveformBars('B');
                });
            });
        }
    </script>
</body>
</html>
